<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanim PDF</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Font Setup: SolaimanLipi (Matching the screenshot) */
        @font-face {
            font-family: 'SolaimanLipi';
            src: local('SolaimanLipi'), url('https://fonts.gstatic.com/s/hindsiliguri/v12/ijwTSyFOwcQQrH4vM1k4b5E.woff2') format('woff2'); 
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'SolaimanLipi', 'Kalpurush', 'Hind Siliguri', 'Arial', sans-serif;
            background-color: #f8fafc; /* Clean background */
        }

        /* Standard Clean Styles */
        .page-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.5rem; }
        
        .file-input-wrapper input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            cursor: pointer; z-index: 50;
        }
    </style>
    
    <!-- PDF.js and jsPDF CDNs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Lucide Icons Setup -->
    <script type="module">
        import { createIcons, Zap, Layout, ArrowDown, Palette, Download, Copy, ChevronLeft, ChevronRight, RefreshCcw, Upload, HardDrive } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';

        window.initIcons = () => {
            createIcons({
                icons: { Zap, Layout, ArrowDown, Palette, Download, Copy, ChevronLeft, ChevronRight, RefreshCcw, Upload, HardDrive }
            });
        };
    </script>
</head>
<body class="min-h-screen text-slate-800">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-white/10 rounded-lg">
                    <i data-lucide="refresh-ccw" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">Tanim PDF</h1>
                    <p class="text-xs text-indigo-200 font-medium">338x190mm (4K Quality)</p>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-6">
        
        <!-- Upload Section -->
        <div id="upload-section" class="file-input-wrapper flex flex-col items-center justify-center h-80 border-3 border-dashed border-indigo-200 rounded-3xl bg-white hover:bg-indigo-50 transition-all duration-300 cursor-pointer relative mt-10 shadow-sm group">
            <input type="file" id="pdfFile" accept="application/pdf" onchange="handleFileUpload(event)">
            <div class="bg-indigo-100 p-6 rounded-full mb-6 group-hover:scale-110 transition-transform duration-300">
                <i data-lucide="upload" class="w-12 h-12 text-indigo-600"></i>
            </div>
            <p class="text-2xl font-bold text-indigo-900 mb-2">পিডিএফ ফাইল আপলোড করুন</p>
            <p class="text-slate-500">ব্রাউজ করতে ক্লিক করুন</p>
        </div>

        <!-- Workspace -->
        <div id="workspace" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8 mt-2">
            
            <!-- Left Sidebar: Controls -->
            <div class="lg:col-span-4 space-y-6">
              
                <!-- Step 1: Invert -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                    <div class="absolute top-0 right-0 bg-indigo-100 px-3 py-1 rounded-bl-xl text-xs font-bold text-indigo-700">ধাপ - ১</div>
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                        <i data-lucide="zap" class="w-5 h-5 text-orange-500"></i> কালার কনভার্টার
                    </h2>
                    
                    <p class="text-sm text-slate-500 mb-4">
                        প্রথমে পিডিএফ-এর রঙ ইনভার্ট (বিপরীত) করুন। সাদা কালো হবে, কালো সাদা হবে।
                    </p>

                    <button 
                      id="invertButton"
                      onclick="toggleInvert()"
                      class="w-full py-4 px-4 rounded-xl flex items-center justify-between transition-all duration-300 border-2 bg-slate-50 border-slate-200 text-slate-600 hover:border-indigo-300"
                    >
                       <span class="font-bold text-lg">ইনভার্ট মোড</span>
                       <div id="invertToggle" class="w-12 h-6 rounded-full p-1 transition-colors duration-300 flex items-center bg-slate-300">
                          <div id="invertCircle" class="bg-white w-4 h-4 rounded-full shadow-sm transform transition-transform duration-300"></div>
                       </div>
                    </button>
                </div>

                <div class="flex justify-center text-slate-300">
                    <i data-lucide="arrow-down" class="w-8 h-8 animate-bounce"></i>
                </div>

                <!-- Step 2: Background -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden">
                     <div class="absolute top-0 right-0 bg-indigo-100 px-3 py-1 rounded-bl-xl text-xs font-bold text-indigo-700">ধাপ - ২</div>
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700">
                        <i data-lucide="palette" class="w-5 h-5 text-pink-500"></i> ব্যাকগ্রাউন্ড কালার
                    </h2>
                    <p class="text-sm text-slate-500 mb-4">
                        এবার আপনার পছন্দমত ব্যাকগ্রাউন্ড সেট করুন (ইনভার্ট করার পর)।
                    </p>

                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <button 
                            onclick="setBgColor('#000000')"
                            class="h-12 rounded-lg border-2 transition-all bg-black border-slate-200 hover:scale-105"
                            id="color-black"
                            title="কালো"
                        ></button>
                        <button 
                            onclick="setBgColor('#ffffff')"
                            class="h-12 rounded-lg border-2 transition-all bg-white border-slate-200 hover:scale-105"
                            id="color-white"
                            title="সাদা"
                        ></button>
                         <button 
                            onclick="setBgColor('#1e293b')"
                            class="h-12 rounded-lg border-2 transition-all bg-slate-800 border-slate-200 hover:scale-105"
                            id="color-dark-slate"
                            title="ডার্ক স্লেট"
                        ></button>
                        <div class="relative h-12 w-full">
                            <input 
                              type="color" 
                              id="bgColorPicker"
                              onchange="setBgColor(this.value)"
                              class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                            />
                            <div class="w-full h-full rounded-lg border-2 flex items-center justify-center border-slate-200 hover:scale-105 bg-gradient-to-br from-gray-100 to-gray-200" id="customColorDisplay">
                               <span class="bg-white/80 text-slate-700 text-[10px] px-1 rounded font-bold shadow-sm">CUSTOM</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-indigo-50 p-3 rounded-lg text-xs text-indigo-700 border border-indigo-100 font-semibold">
                       বর্তমান ব্যাকগ্রাউন্ড: <span class="font-mono font-bold uppercase" id="currentBgColor">#000000</span>
                    </div>
                </div>

                <!-- Final Actions -->
                <div class="bg-slate-800 p-6 rounded-2xl text-white shadow-xl">
                    <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="download" class="w-4 h-4 mr-2"></i> এক্সপোর্ট অপশন</h3>
                    
                    <div class="space-y-3">
                        <button 
                            id="downloadButton"
                            onclick="downloadModifiedPDF()"
                            class="w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold transition disabled:opacity-50 flex items-center justify-center gap-2 shadow-lg"
                        >
                            <span id="downloadText">পিডিএফ ডাউনলোড (4K)</span>
                        </button>
                        
                        <button 
                            id="copyButton"
                            onclick="copyToClipboard()"
                            class="w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-semibold transition flex items-center justify-center gap-2 border border-slate-600"
                        >
                            <i data-lucide="copy" class="w-4 h-4 mr-2"></i> বর্তমান ভিউ কপি করুন
                        </button>
                        
                        <button 
                            onclick="resetApp()"
                            class="w-full text-slate-400 hover:text-white text-sm py-2 transition-colors"
                        >
                            নতুন ফাইল আপলোড
                        </button>
                    </div>
                </div>
                
                <div id="loadingMessage" class="hidden bg-white border-l-4 border-indigo-600 p-4 rounded shadow-lg animate-pulse">
                    <p class="text-indigo-700 font-medium"></p>
                </div>
            </div>

            <!-- Right Sidebar: Preview -->
            <div class="lg:col-span-8">
                <!-- Toolbar -->
                <div class="bg-white p-2 rounded-xl shadow-sm mb-4 flex items-center justify-between px-4 border border-slate-200">
                    <div class="flex items-center gap-2 text-slate-500">
                        <i data-lucide="layout" class="w-5 h-5"></i>
                        <span class="font-semibold text-sm hidden sm:block">লাইভ প্রিভিউ (4K)</span>
                    </div>
                    
                    <div class="flex items-center gap-3">
                         <!-- Drive Preview Button -->
                         <button 
                            onclick="openDrivePreview()"
                            class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg shadow-sm transition text-sm font-bold"
                            title="ব্রাউজার প্রিভিউ (Drive View)"
                        >
                            <i data-lucide="hard-drive" class="w-4 h-4"></i>
                            <span class="hidden sm:inline">ফুল প্রিভিউ</span>
                        </button>

                        <div class="flex items-center gap-2 bg-slate-100 rounded-lg p-1 ml-2">
                            <button 
                                id="prevPage"
                                onclick="changePage(-1)"
                                class="p-2 hover:bg-white rounded-md shadow-sm transition disabled:opacity-30 disabled:shadow-none"
                            >
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <span class="font-mono font-bold w-20 text-center text-sm" id="pageInfo">
                                1 / 1
                            </span>
                            <button 
                                id="nextPage"
                                onclick="changePage(1)"
                                class="p-2 hover:bg-white rounded-md shadow-sm transition disabled:opacity-30 disabled:shadow-none"
                            >
                                <i data-lucide="chevron-right" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Canvas Area -->
                <div class="bg-slate-500/10 rounded-2xl p-8 flex flex-col items-center justify-center min-h-[600px] border-2 border-dashed border-slate-300 overflow-auto relative">
                    <div class="page-shadow rounded-lg overflow-hidden bg-white ring-1 ring-slate-900/5">
                        <canvas id="pdfCanvas" class="max-w-full h-auto block"></canvas>
                    </div>
                    <p class="mt-6 text-slate-400 text-xs font-bold tracking-widest">Tanim PDF • SolaimanLipi</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        let pdfDoc = null;
        let pageNum = 1;
        let numPages = 0;
        let isInverted = false;
        let bgColor = '#000000';
        let isProcessing = false;
        
        // 4K Quality Settings
        const PREVIEW_SCALE = 2.0; 
        const HD_SCALE = 4.0;      

        let DOMElements = {};

        window.onload = function() {
            DOMElements = {
                uploadSection: document.getElementById('upload-section'),
                workspace: document.getElementById('workspace'),
                pdfCanvas: document.getElementById('pdfCanvas'),
                pageInfo: document.getElementById('pageInfo'),
                prevPage: document.getElementById('prevPage'),
                nextPage: document.getElementById('nextPage'),
                invertButton: document.getElementById('invertButton'),
                invertToggle: document.getElementById('invertToggle'),
                invertCircle: document.getElementById('invertCircle'),
                downloadButton: document.getElementById('downloadButton'),
                downloadText: document.getElementById('downloadText'),
                loadingMessage: document.getElementById('loadingMessage'),
                currentBgColor: document.getElementById('currentBgColor'),
                bgColorPicker: document.getElementById('bgColorPicker'),
                customColorDisplay: document.getElementById('customColorDisplay'),
                colorBlack: document.getElementById('color-black'),
                colorWhite: document.getElementById('color-white'),
                colorDarkSlate: document.getElementById('color-dark-slate'),
            };

            if (window.initIcons) {
                try { window.initIcons(); } catch (e) { console.error(e); }
            }
            updateUI();
            setBgColor(bgColor);
        };

        function updateUI() {
            if (!DOMElements.uploadSection) return;

            if (pdfDoc) {
                DOMElements.uploadSection.classList.add('hidden');
                DOMElements.workspace.classList.remove('hidden');
            } else {
                DOMElements.uploadSection.classList.remove('hidden');
                DOMElements.workspace.classList.add('hidden');
                return;
            }

            DOMElements.pageInfo.textContent = `${pageNum} / ${numPages}`;
            DOMElements.prevPage.disabled = pageNum <= 1;
            DOMElements.nextPage.disabled = pageNum >= numPages;

            // Standard Button Styling (Reverted)
            DOMElements.invertButton.className = `w-full py-4 px-4 rounded-xl flex items-center justify-between transition-all duration-300 border-2 ${isInverted ? 'bg-indigo-600 border-indigo-600 text-white shadow-indigo-200 shadow-lg' : 'bg-slate-50 border-slate-200 text-slate-600 hover:border-indigo-300'}`;
            
            DOMElements.invertToggle.className = `w-12 h-6 rounded-full p-1 transition-colors duration-300 flex items-center ${isInverted ? 'bg-white/20' : 'bg-slate-300'}`;
            DOMElements.invertCircle.className = `bg-white w-4 h-4 rounded-full shadow-sm transform transition-transform duration-300 ${isInverted ? 'translate-x-6' : ''}`;

            DOMElements.currentBgColor.textContent = bgColor.toUpperCase();
            DOMElements.bgColorPicker.value = bgColor;
            DOMElements.customColorDisplay.style.backgroundColor = bgColor;

            [DOMElements.colorBlack, DOMElements.colorWhite, DOMElements.colorDarkSlate].forEach(btn => {
                if(btn) {
                    const color = btn.title === 'কালো' ? '#000000' : btn.title === 'সাদা' ? '#ffffff' : '#1e293b';
                    const isActive = color === bgColor;
                    btn.className = `h-12 rounded-lg border-2 transition-all ${isActive ? 'border-indigo-600 ring-2 ring-indigo-100 scale-105' : 'border-slate-200 hover:scale-105'} ${btn.classList.contains('bg-black') ? 'bg-black' : btn.classList.contains('bg-white') ? 'bg-white' : 'bg-slate-800'}`;
                }
            });

            DOMElements.downloadButton.disabled = isProcessing;
            DOMElements.downloadText.textContent = isProcessing ? 'প্রসেসিং হচ্ছে...' : 'পিডিএফ ডাউনলোড (4K)';
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf' && window.pdfjsLib) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    try {
                        showLoading('ফাইল লোড হচ্ছে...');
                        const loadingTask = window.pdfjsLib.getDocument({ data: typedarray });
                        pdfDoc = await loadingTask.promise;
                        numPages = pdfDoc.numPages;
                        pageNum = 1;
                        isInverted = false;
                        bgColor = '#000000';
                        hideLoading();
                        renderPage();
                        updateUI();
                    } catch (error) {
                        alert('পিডিএফ লোড এরর।');
                        hideLoading();
                    }
                };
                reader.readAsArrayBuffer(file);
            } else if (file) {
                 alert('সঠিক পিডিএফ ফাইল দিন।');
            }
        }

        function toggleInvert() {
            isInverted = !isInverted;
            renderPage();
            updateUI();
        }

        function setBgColor(color) {
            bgColor = color;
            renderPage();
            updateUI();
        }

        function changePage(delta) {
            const newPage = pageNum + delta;
            if (newPage >= 1 && newPage <= numPages) {
                pageNum = newPage;
                renderPage();
                updateUI();
            }
        }

        function resetApp() {
            pdfDoc = null;
            pageNum = 1;
            numPages = 0;
            isInverted = false;
            bgColor = '#000000';
            isProcessing = false;
            document.getElementById('pdfFile').value = '';
            const ctx = DOMElements.pdfCanvas.getContext('2d');
            ctx.clearRect(0, 0, DOMElements.pdfCanvas.width, DOMElements.pdfCanvas.height);
            updateUI();
        }

        function showLoading(message) {
            if(DOMElements.loadingMessage) {
                DOMElements.loadingMessage.classList.remove('hidden');
                DOMElements.loadingMessage.querySelector('p').textContent = message;
            }
        }

        function hideLoading() {
            if(DOMElements.loadingMessage) {
                DOMElements.loadingMessage.classList.add('hidden');
            }
        }

        function processImageData(data, inverted, backgroundHex) {
            const rTarget = parseInt(backgroundHex.slice(1, 3), 16);
            const gTarget = parseInt(backgroundHex.slice(3, 5), 16);
            const bTarget = parseInt(backgroundHex.slice(5, 7), 16);
            
            const origBgR = data[0];
            const origBgG = data[1];
            const origBgB = data[2];

            const threshold = 60; 

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];

                const isBackground = 
                    Math.abs(r - origBgR) < threshold &&
                    Math.abs(g - origBgG) < threshold &&
                    Math.abs(b - origBgB) < threshold;

                if (isBackground) {
                    data[i] = rTarget;
                    data[i + 1] = gTarget;
                    data[i + 2] = bTarget;
                } else {
                    if (inverted) {
                        data[i] = 255 - r;
                        data[i + 1] = 255 - g;
                        data[i + 2] = 255 - b;
                    }
                }
            }
        }

        async function renderPage() {
            if (!pdfDoc) return;
            showLoading('প্রিভিউ রেন্ডার হচ্ছে (High Quality)...');
            
            const page = await pdfDoc.getPage(pageNum);
            const canvas = DOMElements.pdfCanvas;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            const viewport = page.getViewport({ scale: PREVIEW_SCALE });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            processImageData(imageData.data, isInverted, bgColor);
            ctx.putImageData(imageData, 0, 0);
            
            hideLoading();
        }

        async function openDrivePreview() {
            if (!pdfDoc || isProcessing || !window.jspdf) return;
            isProcessing = true;
            updateUI();
            
            try {
                const { jsPDF } = window.jspdf;
                const targetWidth = 338;
                const targetHeight = 190;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [targetWidth, targetHeight] });
                
                for (let i = 1; i <= numPages; i++) {
                    showLoading(`প্রিভিউ তৈরি হচ্ছে: ${i} / ${numPages}...`);
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: HD_SCALE });
                    
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = viewport.width;
                    tempCanvas.height = viewport.height;
                    const ctx = tempCanvas.getContext('2d', { willReadFrequently: true });

                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    processImageData(imageData.data, isInverted, bgColor);
                    ctx.putImageData(imageData, 0, 0);

                    const imgDataUrl = tempCanvas.toDataURL('image/jpeg', 0.90);
                    if (i > 1) doc.addPage([targetWidth, targetHeight], 'landscape');
                    doc.addImage(imgDataUrl, 'JPEG', 0, 0, targetWidth, targetHeight);
                }

                const pdfBlob = doc.output('blob');
                const blobUrl = URL.createObjectURL(pdfBlob);
                window.open(blobUrl, '_blank'); 
                
                hideLoading();
            } catch (err) {
                console.error(err);
                alert('প্রিভিউ তৈরি করতে সমস্যা হয়েছে।');
                hideLoading();
            } finally {
                isProcessing = false;
                updateUI();
            }
        }

        async function downloadModifiedPDF() {
            if (!pdfDoc || isProcessing || !window.jspdf) return;
            isProcessing = true;
            updateUI();
            
            try {
                const { jsPDF } = window.jspdf;
                const targetWidth = 338;
                const targetHeight = 190;
                const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [targetWidth, targetHeight] });
                
                for (let i = 1; i <= numPages; i++) {
                    showLoading(`ডাউনলোডের জন্য প্রসেসিং: ${i} / ${numPages}...`);
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: HD_SCALE }); 
                    
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = viewport.width;
                    tempCanvas.height = viewport.height;
                    const ctx = tempCanvas.getContext('2d', { willReadFrequently: true });

                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    processImageData(imageData.data, isInverted, bgColor);
                    ctx.putImageData(imageData, 0, 0);

                    const imgDataUrl = tempCanvas.toDataURL('image/jpeg', 0.95);
                    if (i > 1) doc.addPage([targetWidth, targetHeight], 'landscape');
                    doc.addImage(imgDataUrl, 'JPEG', 0, 0, targetWidth, targetHeight);
                }
                
                doc.save('modified_pdf_4k.pdf');
                hideLoading();
            } catch (err) {
                console.error(err);
                alert('সমস্যা হয়েছে।');
                hideLoading();
            } finally {
                isProcessing = false;
                updateUI();
            }
        }

        function copyToClipboard() {
            if (!DOMElements.pdfCanvas) return;
            DOMElements.pdfCanvas.toBlob(blob => {
              if (blob) {
                 try {
                    const item = new ClipboardItem({ 'image/png': blob });
                    navigator.clipboard.write([item]);
                    alert('কপি হয়েছে!');
                 } catch (err) { alert('ব্রাউজার সাপোর্ট করছে না।'); }
              }
            }, 'image/png');
        }
    </script>
</body>
</html>
